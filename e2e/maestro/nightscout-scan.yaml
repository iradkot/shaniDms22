appId: com.shanidms22
---
# Nightscout scan: verify the app is using live Nightscout polling
# (not the deterministic E2E fallback snapshot).
#
# This uses the app's built-in Nightscout base URL + api-secret.

- launchApp:
    clearState: true

# Deterministic E2E login.
- extendedWaitUntil:
    visible:
      id: login.e2eButton
    timeout: 15000
    optional: true

- tapOn:
    id: login.e2eButton
    optional: true

# Wait for Home.
- extendedWaitUntil:
    visible:
      id: screen.home
    timeout: 30000

# Validate data source marker:
# - On real devices / connected Nightscout: expect `homeHeader.source.nightscout`
# - In E2E mode (deterministic): accept `homeHeader.source.fallback`
- extendedWaitUntil:
        visible:
            id: homeHeader.source.nightscout
        timeout: 15000
        optional: true

- runFlow:
        when:
            visible:
                id: homeHeader.source.nightscout
        commands:
            - assertVisible:
                    id: homeHeader.source.nightscout

- runFlow:
        when:
            notVisible:
                id: homeHeader.source.nightscout
        commands:
            - extendedWaitUntil:
                    visible:
                        id: homeHeader.source.fallback
                    timeout: 30000
            - assertVisible:
                    id: homeHeader.source.fallback

# Sanity: header is interactive and expands.
- assertVisible:
    id: homeHeader.toggle

- tapOn:
    id: homeHeader.toggle

- extendedWaitUntil:
    visible:
      id: loadBars.container
    timeout: 15000

- takeScreenshot: nightscout-scan
